on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  mobile:
    name: Generate (mobile)
    runs-on: ubuntu-latest
    env:
      BUNDLE_SEQ: ${{ github.run_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Run generator (mobile)
        run: |
          python3 merge_macros.py \
            --input-dir originals \
            --output-dir output \
            --group mobile \
            --versions 6 \
            --seed 1 \
            --max-files 0

      - name: Zip mobile group
        run: |
          cd output
          # find the bundle folder
          BUNDLE_DIR=$(ls -d merged_bundle_${BUNDLE_SEQ}/* | grep -i mobile || true)
          # fall back to the whole bundle if mobile subfolder not found
          if [ -z "$BUNDLE_DIR" ]; then
            zip -r merged_bundle_${BUNDLE_SEQ}_mobile.zip merged_bundle_${BUNDLE_SEQ} || true
          else
            zip -r merged_bundle_${BUNDLE_SEQ}_mobile.zip "$BUNDLE_DIR" || true
          fi
          ls -lh merged_bundle_${BUNDLE_SEQ}_mobile.zip

      - name: Upload mobile artifacts
        uses: actions/upload-artifact@v4
        with:
          name: merged_bundle_${{ env.BUNDLE_SEQ }}-mobile
          path: |
            output/merged_bundle_${{ env.BUNDLE_SEQ }}_mobile.zip
            output/merged_bundle_${{ env.BUNDLE_SEQ }}/manifest_${{ env.BUNDLE_SEQ }}.json

  desktop:
    name: Generate (desktop)
    runs-on: ubuntu-latest
    env:
      BUNDLE_SEQ: ${{ github.run_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Run generator (desktop)
        run: |
          python3 merge_macros.py \
            --input-dir originals \
            --output-dir output \
            --group desktop \
            --versions 6 \
            --seed 1 \
            --max-files 0

      - name: Zip desktop group
        run: |
          cd output
          BUNDLE_DIR=$(ls -d merged_bundle_${BUNDLE_SEQ}/* | grep -i deskt || true)
          if [ -z "$BUNDLE_DIR" ]; then
            zip -r merged_bundle_${BUNDLE_SEQ}_desktop.zip merged_bundle_${BUNDLE_SEQ} || true
          else
            zip -r merged_bundle_${BUNDLE_SEQ}_desktop.zip "$BUNDLE_DIR" || true
          fi
          ls -lh merged_bundle_${BUNDLE_SEQ}_desktop.zip

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: merged_bundle_${{ env.BUNDLE_SEQ }}-desktop
          path: |
            output/merged_bundle_${{ env.BUNDLE_SEQ }}_desktop.zip
            output/merged_bundle_${{ env.BUNDLE_SEQ }}/manifest_${{ env.BUNDLE_SEQ }}.json
