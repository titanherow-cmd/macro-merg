name: Merge macros — seconds-based UI, no-repeat pauses (with cleanup)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      input_dir:
        description: 'Parent directory containing group subfolders (relative to repo root)'
        required: true
        default: 'originals'
      output_dir:
        description: 'Directory to write merged files (relative to repo root)'
        required: true
        default: 'merged_output'
      versions:
        description: 'How many versions to generate per group'
        required: true
        default: '16'
      within_max_time_secs:
        description: 'Max pause inside-file in seconds (0..N). Default 33.'
        required: true
        default: '33'
      within_max_pauses:
        description: 'Max pauses inside each file'
        required: true
        default: '3'
      between_max_time_secs:
        description: 'Max pause between files in seconds (0..N). Default 18.'
        required: true
        default: '18'
      between_max_pauses:
        description: 'Max pauses between files (kept for compatibility; placed last)'
        required: true
        default: '1'
      exclude_count:
        description: 'Max files to randomly exclude per version (0–N-1)'
        required: true
        default: '5'
      seed:
        description: 'Optional RNG seed (blank = random)'
        required: false
        default: ''

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # expose inputs as env vars so run: blocks use only $VAR (avoids YAML expression pitfalls)
    env:
      INPUT_DIR: ${{ github.event.inputs.input_dir }}
      OUTPUT_DIR: ${{ github.event.inputs.output_dir }}
      VERSIONS: ${{ github.event.inputs.versions }}
      WITHIN_MAX_SECS: ${{ github.event.inputs.within_max_time_secs }}
      WITHIN_MAX_PAUSES: ${{ github.event.inputs.within_max_pauses }}
      BETWEEN_MAX_SECS: ${{ github.event.inputs.between_max_time_secs }}
      BETWEEN_MAX_PAUSES: ${{ github.event.inputs.between_max_pauses }}
      EXCLUDE_COUNT: ${{ github.event.inputs.exclude_count }}
      SEED_INPUT: ${{ github.event.inputs.seed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Bump merge counter
        run: |
          set -euo pipefail
          COUNTER_FILE=".github/merge_bundle_counter.txt"
          mkdir -p "$(dirname "$COUNTER_FILE")"
          PREV=0
          if [ -f "$COUNTER_FILE" ]; then
            PREV=$(cat "$COUNTER_FILE" | tr -d '[:space:]' || echo 0)
          fi
          NEXT=$((PREV + 1))
          echo "$NEXT" > "$COUNTER_FILE"
          echo "BUNDLE_SEQ=$NEXT" >> "$GITHUB_ENV"
          echo "Counter bumped from $PREV to $NEXT"

      - name: Clean previous merged output (safe)
        run: |
          set -euo pipefail
          echo "Cleaning possible previous outputs..."
          # remove previous outputs only (safe: does not touch originals/ or .github/)
          rm -rf "$OUTPUT_DIR" merged_output output || true
          echo "Clean finished."

      - name: Run merge_macros.py
        run: |
          set -euo pipefail
          SEED_ARG=""
          if [ -n "${SEED_INPUT}" ]; then
            SEED_ARG="--seed ${SEED_INPUT}"
          fi

          echo "Running merge_macros.py with:"
          echo "  input-dir:        $INPUT_DIR"
          echo "  output-dir:       $OUTPUT_DIR"
          echo "  versions:         $VERSIONS"
          echo "  within-max-secs:  $WITHIN_MAX_SECS"
          echo "  within-max-pauses:$WITHIN_MAX_PAUSES"
          echo "  between-max-secs: $BETWEEN_MAX_SECS"
          echo "  between-max-pauses:$BETWEEN_MAX_PAUSES"
          echo "  exclude-count:    $EXCLUDE_COUNT"
          echo "  seed:             ${SEED_INPUT:-<none>}"
          echo "----- START SCRIPT OUTPUT -----"

          python3 merge_macros.py \
            --input-dir "$INPUT_DIR" \
            --output-dir "$OUTPUT_DIR" \
            --versions "$VERSIONS" \
            ${SEED_ARG} \
            --exclude-count "$EXCLUDE_COUNT" \
            --intra-file-enabled \
            --intra-file-max 999999 \
            --within-max-time-secs "$WITHIN_MAX_SECS" \
            --within-max-pauses "$WITHIN_MAX_PAUSES" \
            --between-max-time-secs "$BETWEEN_MAX_SECS" \
            --between-max-pauses "$BETWEEN_MAX_PAUSES"

          echo "----- END SCRIPT OUTPUT -----"

      - name: Commit updated counter
        if: always()
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -f ".github/merge_bundle_counter.txt" ]; then
            git add .github/merge_bundle_counter.txt
            if git diff --cached --quiet; then
              echo "No counter changes to commit."
            else
              git commit -m "Update merge bundle counter [skip ci]" || true
              git push origin HEAD || true
            fi
          fi

      - name: Show merged outputs (debug)
        if: always()
        run: |
          echo "Merged bundle zips (if any):"
          find "$OUTPUT_DIR" -type f -name "merged_bundle*.zip" -exec ls -lh {} \; || true

      - name: Upload merged bundle artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: merged-bundle
          path: '**/merged_bundle*.zip'
